<template
  name="Optimization Step"
  id="step"
  repeat="*" 
  offset="0"
  endOffset="0"
  pattern="\s*Step\s*\d+\s*$\s*\-{8}\s*" 
  endPattern="(\s*Optimization converged\s*)|\s*Step\s*\d+\s*" 
  >
  
  <comment class="example.input" id="step">
          Step   0
          --------


                         Geometry "geometry" -> "geometry"
                         ---------------------------------

 Output coordinates in angstroms (scale by  1.889725989 to convert to a.u.)

  No.       Tag          Charge          X              Y              Z
 ---- ---------------- ---------- -------------- -------------- --------------
    1 O                    8.0000     0.00000000     0.00000000     0.11726921
    2 H                    1.0000     0.75698224     0.00000000    -0.46907685
    3 H                    1.0000    -0.75698224     0.00000000    -0.46907685

      Atomic Mass 
      ----------- 

      O                 15.994910
      H                  1.007825


 Effective nuclear repulsion energy (a.u.)       9.1920946687

            Nuclear Dipole moment (a.u.) 
            ----------------------------
        X                 Y               Z
 ---------------- ---------------- ----------------
     0.0000000000     0.0000000000     0.0000000000

      Symmetry information
      --------------------

 Group name             C2v       
 Group number             16
 Group order               4
 No. of unique centers     2

      Symmetry unique atoms

     1    2

                                 NWChem SCF Module
                                 -----------------


                  HF SCF optimisation  on water with STO-3G basis



  ao basis        = "ao basis"
  functions       =     7
  atoms           =     3
  closed shells   =     5
  open shells     =     0
  charge          =   0.00
  wavefunction    = RHF 
  input vectors   = atomic
  output vectors  = ./molecule.movecs
  use symmetry    = T
  symmetry adapt  = T


 Summary of "ao basis" -> "ao basis" (cartesian)
 ------------------------------------------------------------------------------
       Tag                 Description            Shells   Functions and Types
 ---------------- ------------------------------  ------  ---------------------
 O                           sto-3g                  3        5   2s1p
 H                           sto-3g                  1        1   1s


      Symmetry analysis of basis
      --------------------------

        a1          4
        a2          0
        b1          2
        b2          1


 Forming initial guess at       0.0s


      Superposition of Atomic Density Guess
      -------------------------------------

 Sum of atomic energies:         -74.71095592

      Non-variational initial energy
      ------------------------------

 Total energy =     -74.683500
 1-e energy   =    -121.780484
 2-e energy   =      37.904889
 HOMO         =      -0.258445
 LUMO         =       0.505071


      Symmetry analysis of molecular orbitals - initial
      -------------------------------------------------

  Numbering of irreducible representations: 

     1 a1          2 a2          3 b1          4 b2      

  Orbital symmetries:

     1 a1          2 a1          3 b1          4 a1          5 b2      
     6 a1          7 b1      


 Starting SCF solution at       0.1s



 ----------------------------------------------
         Quadratically convergent ROHF

 Convergence threshold     :          1.000E-04
 Maximum no. of iterations :           30
 Final Fock-matrix accuracy:          1.000E-07
 ----------------------------------------------


 #quartets = 7.900D+01 #integrals = 1.640D+02 #direct =  0.0% #cached =100.0%


 Integral file          = ./molecule.aoints.0
 Record size in doubles =  65536        No. of integs per rec  =  43688
 Max. records in memory =      2        Max. records in file   = 148936
 No. of bits per label  =      8        No. of bits per value  =     64


              iter       energy          gnorm     gmax       time
             ----- ------------------- --------- --------- --------
                 1      -74.9243813595  6.49D-01  5.52D-01      0.1
                 2      -74.9621547150  1.36D-01  1.01D-01      0.1
                 3      -74.9629674753  2.06D-02  1.64D-02      0.1
                 4      -74.9629856144  5.45D-05  4.16D-05      0.1


       Final RHF  results 
       ------------------ 

         Total SCF energy =    -74.962985614357
      One-electron energy =   -122.365883795384
      Two-electron energy =     38.210803512371
 Nuclear repulsion energy =      9.192094668657

        Time for solution =      0.0s



       Symmetry analysis of molecular orbitals - final
       -----------------------------------------------

  Numbering of irreducible representations: 

     1 a1          2 a2          3 b1          4 b2      

  Orbital symmetries:

     1 a1          2 a1          3 b1          4 a1          5 b2      
     6 a1          7 b1      

             Final eigenvalues
             -----------------

              1      
    1  -20.2418
    2   -1.2683
    3   -0.6177
    4   -0.4531
    5   -0.3913
    6    0.6054
    7    0.7419

                       ROHF Final Molecular Orbital Analysis
                       -------------------------------------

 Vector    2  Occ=2.000000D+00  E=-1.268298D+00  Symmetry=a1
              MO Center= -2.8D-17, -9.9D-19, -7.2D-02, r^2= 5.4D-01
   Bfn.  Coefficient  Atom+Function         Bfn.  Coefficient  Atom+Function  
  ----- ------------  ---------------      ----- ------------  ---------------
     2      0.833587  1 O  s                  1     -0.232793  1 O  s          
     6      0.158700  2 H  s                  7      0.158700  3 H  s          

 Vector    3  Occ=2.000000D+00  E=-6.177034D-01  Symmetry=b1
              MO Center=  2.8D-17, -1.0D-51, -1.4D-01, r^2= 8.3D-01
   Bfn.  Coefficient  Atom+Function         Bfn.  Coefficient  Atom+Function  
  ----- ------------  ---------------      ----- ------------  ---------------
     3      0.606495  1 O  px                 6      0.445042  2 H  s          
     7     -0.445042  3 H  s          

 Vector    4  Occ=2.000000D+00  E=-4.530557D-01  Symmetry=a1
              MO Center=  0.0D+00,  2.0D-35,  1.6D-01, r^2= 6.2D-01
   Bfn.  Coefficient  Atom+Function         Bfn.  Coefficient  Atom+Function  
  ----- ------------  ---------------      ----- ------------  ---------------
     5      0.776552  1 O  pz                 2      0.536883  1 O  s          
     6     -0.277990  2 H  s                  7     -0.277990  3 H  s          

 Vector    5  Occ=2.000000D+00  E=-3.912526D-01  Symmetry=b2
              MO Center= -5.2D-33, -4.4D-18,  1.2D-01, r^2= 4.2D-01
   Bfn.  Coefficient  Atom+Function         Bfn.  Coefficient  Atom+Function  
  ----- ------------  ---------------      ----- ------------  ---------------
     4      1.000000  1 O  py         

 Vector    6  Occ=0.000000D+00  E= 6.054409D-01  Symmetry=a1
              MO Center=  6.1D-16,  5.3D-18, -3.9D-01, r^2= 1.1D+00
   Bfn.  Coefficient  Atom+Function         Bfn.  Coefficient  Atom+Function  
  ----- ------------  ---------------      ----- ------------  ---------------
     2      0.884136  1 O  s                  6     -0.796892  2 H  s          
     7     -0.796892  3 H  s                  5     -0.742518  1 O  pz         

 Vector    7  Occ=0.000000D+00  E= 7.419112D-01  Symmetry=b1
              MO Center= -7.2D-16,  3.1D-33, -2.3D-01, r^2= 1.0D+00
   Bfn.  Coefficient  Atom+Function         Bfn.  Coefficient  Atom+Function  
  ----- ------------  ---------------      ----- ------------  ---------------
     3      0.990301  1 O  px                 6     -0.838447  2 H  s          
     7      0.838447  3 H  s          


 center of mass
 --------------
 x =   0.00000000 y =   0.00000000 z =   0.09760123

 moments of inertia (a.u.)
 ------------------
           2.197735387303           0.000000000000           0.000000000000
           0.000000000000           6.322357589609           0.000000000000
           0.000000000000           0.000000000000           4.124622202307

  Mulliken analysis of the total density
  --------------------------------------

    Atom       Charge   Shell Charges
 -----------   ------   -------------------------------------------------------
    1 O    8     8.37   2.00  1.83  4.54
    2 H    1     0.82   0.82
    3 H    1     0.82   0.82

       Multipole analysis of the density wrt the origin
       ------------------------------------------------

     L   x y z        total         open         nuclear
     -   - - -        -----         ----         -------
     0   0 0 0     -0.000000      0.000000     10.000000

     1   1 0 0      0.000000      0.000000      0.000000
     1   0 1 0      0.000000      0.000000      0.000000
     1   0 0 1     -0.678952      0.000000      0.000000

     2   2 0 0     -3.240572      0.000000      4.092598
     2   1 1 0     -0.000000      0.000000      0.000000
     2   1 0 1      0.000000      0.000000      0.000000
     2   0 2 0     -4.531209      0.000000      0.000000
     2   0 1 1     -0.000000      0.000000      0.000000
     2   0 0 2     -4.009700      0.000000      1.964381


 Parallel integral file used       1 records with       0 large values

                              NWChem Gradients Module
                              -----------------------


                  HF SCF optimisation  on water with STO-3G basis


  wavefunction    =   RHF     

  Using symmetry


                         RHF ENERGY GRADIENTS

    atom               coordinates                        gradient
                 x          y          z           x          y          z
   1 O       0.000000   0.000000   0.221607    0.000000   0.000000  -0.061840
   2 H       1.430489   0.000000  -0.886427   -0.023949   0.000000   0.030920
   3 H      -1.430489   0.000000  -0.886427    0.023949   0.000000   0.030920

                 ----------------------------------------
                 |  Time  |  1-e(secs)   |  2-e(secs)   |
                 ----------------------------------------
                 |  CPU   |       0.00   |       0.00   |
                 ----------------------------------------
                 |  WALL  |       0.00   |       0.00   |
                 ----------------------------------------

@ Step       Energy      Delta E   Gmax     Grms     Xrms     Xmax   Walltime
@ ---- ---------------- -------- -------- -------- -------- -------- --------
@    0     -74.96298561  0.0D+00  0.03787  0.03139  0.00000  0.00000      0.2
                                                                    



                                Z-matrix (autoz)
                                -------- 

 Units are Angstrom for bonds and degrees for angles

      Type          Name      I     J     K     L     M      Value     Gradient
      ----------- --------  ----- ----- ----- ----- ----- ---------- ----------
    1 Stretch                  1     2                       0.95751   -0.03787
    2 Stretch                  1     3                       0.95751   -0.03787
    3 Bend                     2     1     3               104.47845    0.00936

                                 NWChem SCF Module
                                 -----------------


                  HF SCF optimisation  on water with STO-3G basis



  ao basis        = "ao basis"
  functions       =     7
  atoms           =     3
  closed shells   =     5
  open shells     =     0
  charge          =   0.00
  wavefunction    = RHF 
  input vectors   = ./molecule.movecs
  output vectors  = ./molecule.movecs
  use symmetry    = T
  symmetry adapt  = T


 Summary of "ao basis" -> "ao basis" (cartesian)
 ------------------------------------------------------------------------------
       Tag                 Description            Shells   Functions and Types
 ---------------- ------------------------------  ------  ---------------------
 O                           sto-3g                  3        5   2s1p
 H                           sto-3g                  1        1   1s


      Symmetry analysis of basis
      --------------------------

        a1          4
        a2          0
        b1          2
        b2          1


 Forming initial guess at       0.2s


 Loading old vectors from job with title :

HF SCF optimisation  on water with STO-3G basis


      Symmetry analysis of molecular orbitals - initial
      -------------------------------------------------

  Numbering of irreducible representations: 

     1 a1          2 a2          3 b1          4 b2      

  Orbital symmetries:

     1 a1          2 a1          3 b1          4 a1          5 b2      
     6 a1          7 b1      


 Starting SCF solution at       0.2s



 ----------------------------------------------
         Quadratically convergent ROHF

 Convergence threshold     :          1.000E-04
 Maximum no. of iterations :           30
 Final Fock-matrix accuracy:          1.000E-07
 ----------------------------------------------


 #quartets = 7.900D+01 #integrals = 1.640D+02 #direct =  0.0% #cached =100.0%


 Integral file          = ./molecule.aoints.0
 Record size in doubles =  65536        No. of integs per rec  =  43688
 Max. records in memory =      2        Max. records in file   = 148936
 No. of bits per label  =      8        No. of bits per value  =     64


              iter       energy          gnorm     gmax       time
             ----- ------------------- --------- --------- --------
                 1      -74.9631387575  1.16D-01  9.34D-02      0.1
                 2      -74.9647154510  6.37D-03  4.58D-03      0.1
                 3      -74.9647184181  6.79D-07  5.46D-07      0.1


       Final RHF  results 
       ------------------ 

         Total SCF energy =    -74.964718418072
      One-electron energy =   -121.462734827331
      Two-electron energy =     37.794538223922
 Nuclear repulsion energy =      8.703478185337

        Time for solution =      0.0s



       Symmetry analysis of molecular orbitals - final
       -----------------------------------------------

  Numbering of irreducible representations: 

     1 a1          2 a2          3 b1          4 b2      

  Orbital symmetries:

     1 a1          2 a1          3 b1          4 a1          5 b2      
     6 a1          7 b1      

             Final eigenvalues
             -----------------

              1      
    1  -20.2563
    2   -1.2481
    3   -0.5800
    4   -0.4599
    5   -0.3925
    6    0.5619
    7    0.6633

                       ROHF Final Molecular Orbital Analysis
                       -------------------------------------

 Vector    2  Occ=2.000000D+00  E=-1.248068D+00  Symmetry=a1
              MO Center= -4.2D-17, -9.4D-19, -1.7D-02, r^2= 5.4D-01
   Bfn.  Coefficient  Atom+Function         Bfn.  Coefficient  Atom+Function  
  ----- ------------  ---------------      ----- ------------  ---------------
     2      0.853015  1 O  s                  1     -0.234730  1 O  s          
     6      0.153310  2 H  s                  7      0.153310  3 H  s          

 Vector    3  Occ=2.000000D+00  E=-5.800290D-01  Symmetry=b1
              MO Center=  2.8D-17, -5.6D-37, -1.3D-01, r^2= 8.6D-01
   Bfn.  Coefficient  Atom+Function         Bfn.  Coefficient  Atom+Function  
  ----- ------------  ---------------      ----- ------------  ---------------
     3      0.615049  1 O  px                 6      0.450841  2 H  s          
     7     -0.450841  3 H  s          

 Vector    4  Occ=2.000000D+00  E=-4.599075D-01  Symmetry=a1
              MO Center=  0.0D+00,  4.2D-19,  1.6D-01, r^2= 6.9D-01
   Bfn.  Coefficient  Atom+Function         Bfn.  Coefficient  Atom+Function  
  ----- ------------  ---------------      ----- ------------  ---------------
     5      0.747027  1 O  pz                 2      0.531910  1 O  s          
     6     -0.305078  2 H  s                  7     -0.305078  3 H  s          

 Vector    5  Occ=2.000000D+00  E=-3.925164D-01  Symmetry=b2
              MO Center= -5.6D-33, -4.7D-18,  1.7D-01, r^2= 4.2D-01
   Bfn.  Coefficient  Atom+Function         Bfn.  Coefficient  Atom+Function  
  ----- ------------  ---------------      ----- ------------  ---------------
     4      1.000000  1 O  py         

 Vector    6  Occ=0.000000D+00  E= 5.619166D-01  Symmetry=a1
              MO Center=  6.1D-16,  5.2D-18, -3.7D-01, r^2= 1.1D+00
   Bfn.  Coefficient  Atom+Function         Bfn.  Coefficient  Atom+Function  
  ----- ------------  ---------------      ----- ------------  ---------------
     2      0.780130  1 O  s                  5     -0.768189  1 O  pz         
     6     -0.752065  2 H  s                  7     -0.752065  3 H  s          

 Vector    7  Occ=0.000000D+00  E= 6.632681D-01  Symmetry=b1
              MO Center= -6.7D-16,  0.0D+00, -2.2D-01, r^2= 1.0D+00
   Bfn.  Coefficient  Atom+Function         Bfn.  Coefficient  Atom+Function  
  ----- ------------  ---------------      ----- ------------  ---------------
     3      0.943982  1 O  px                 6     -0.797398  2 H  s          
     7      0.797398  3 H  s          


 center of mass
 --------------
 x =   0.00000000 y =   0.00000000 z =   0.17484518

 moments of inertia (a.u.)
 ------------------
           2.784796110099           0.000000000000           0.000000000000
           0.000000000000           7.033815787773           0.000000000000
           0.000000000000           0.000000000000           4.249019677674

  Mulliken analysis of the total density
  --------------------------------------

    Atom       Charge   Shell Charges
 -----------   ------   -------------------------------------------------------
    1 O    8     8.31   2.00  1.86  4.45
    2 H    1     0.85   0.85
    3 H    1     0.85   0.85

       Multipole analysis of the density wrt the origin
       ------------------------------------------------

     L   x y z        total         open         nuclear
     -   - - -        -----         ----         -------
     0   0 0 0     -0.000000      0.000000     10.000000

     1   1 0 0      0.000000      0.000000      0.000000
     1   0 1 0      0.000000      0.000000      0.000000
     1   0 0 1     -0.662213      0.000000      0.649789

     2   2 0 0     -3.360070      0.000000      4.216029
     2   1 1 0     -0.000000      0.000000      0.000000
     2   1 0 1      0.000000      0.000000      0.000000
     2   0 2 0     -4.569383      0.000000      0.000000
     2   0 1 1     -0.000000      0.000000      0.000000
     2   0 0 2     -4.036794      0.000000      2.531330


 Parallel integral file used       1 records with       0 large values

 Line search: 
     step= 1.00 grad=-9.7D-03 hess= 8.0D-03 energy=    -74.964718 mode=downhill
 new step= 0.61                   predicted energy=    -74.965943


  </comment>

  <record id="skip">\s*Step\s+{I,cc:step}</record>
  <record/>
  <transform process="delete" xpath=".//cml:list[@cmlx:templateRef='missingID']"/>
  
  
  <templateList xmlns:xi="http://www.w3.org/2001/XInclude">
     <xi:include href="geometry.xml" />
     <xi:include href="module.xml" />
     <xi:include href="geomopt.stepdata.xml" />
  </templateList>

<!-- Turn each step into a calculation -->
  <transform process="addDictRef" 
  xpath="."
  value="compchem:calculation"/>
  
  <transform process="addId" 
  xpath="."
  value="step"/>
  
  <!-- Copy first calculation initialization module and then just change the task -->
  <transform process="copy"
  xpath="./cml:module[@cmlx:templateRef='nwchem_module'][position()=1]/cml:module[@dictRef='compchem:calculation']/cml:module[@dictRef='compchem:initialization']"  
  to="../../.."
  />
  <transform process="delete"
  xpath="./cml:module[@dictRef='compchem:initialization']/cml:parameterList/cml:parameter[@dictRef='compchem:task']"
  />
  <transform process="addChild"
  xpath="./cml:module[@dictRef='compchem:initialization']/cml:parameterList"
  elementName="cml:scalar"
  dictRef="compchem:task"
  value="step"
  />
  <transform process="createWrapperParameter"
  xpath="./cml:module[@dictRef='compchem:initialization']/cml:parameterList/cml:scalar"
  />
  
     <!-- FILTHY HACK! -->
  <!-- Move over the mp2 method - move not copy as we need to put at top of list _shudder_ 
  Will fix when we can do tests and proper copies
  -->
  <transform process="moveRelative"
  xpath="./cml:module[@cmlx:templateRef='nwchem_module'][position()=2]/cml:module[@dictRef='compchem:calculation']/cml:module[@dictRef='compchem:initialization']/cml:parameterList/cml:parameter[@dictRef='compchem:method']/cml:scalar[text()='mp2']"        
  to="../../../../../../cml:module[@dictRef='compchem:initialization']/cml:parameterList"
  position="1"
  /> 
  <transform process="addDictRef"
  xpath="./cml:module[@dictRef='compchem:initialization']/cml:parameterList/cml:scalar[text()='mp2']"
  value="compchem:method"
  />
  <transform process="createWrapperParameter"
  xpath="./cml:module[@dictRef='compchem:initialization']/cml:parameterList/cml:scalar[text()='mp2']"
  />
  
  
  <!-- Copy finalization module from last calculation module to be our finalization --> 
    <transform process="copy"
    xpath="./cml:module[@cmlx:templateRef='nwchem_module'][position()=last()]/cml:module[@dictRef='compchem:calculation']/cml:module[@dictRef='compchem:finalization']"   
    to="../../.."
    />
  
  <comment class="example.output" id="step">
    <module/>
  </comment>

</template>
