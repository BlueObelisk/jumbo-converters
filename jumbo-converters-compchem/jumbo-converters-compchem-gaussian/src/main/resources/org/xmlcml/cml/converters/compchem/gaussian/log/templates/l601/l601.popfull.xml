<template id="l601.popfull" repeat="*"
		  pattern="\s*Full Mulliken population analysis.*"
		  endPattern="\s*Gross orbital populations.*" endOffset="0">

	<comment class="example.input" id="l601.popfull">
   Full Mulliken population analysis:
                           1         2         3         4         5
   1 1   O  1S          2.07485
   2        2S         -0.04107   0.50455
   3        2PX         0.00000   0.00000   0.83097
   4        2PY         0.00000   0.00000   0.00000   0.53551
   5        2PZ         0.00000   0.00000   0.00000   0.00000   0.64157
   6        3S         -0.03955   0.42650   0.00000   0.00000   0.00000
   7        3PX         0.00000   0.00000   0.32718   0.00000   0.00000
   8        3PY         0.00000   0.00000   0.00000   0.14002   0.00000
   9        3PZ         0.00000   0.00000   0.00000   0.00000   0.21372
  10        4XX        -0.00036  -0.00589   0.00000   0.00000   0.00000
  11        4YY        -0.00079   0.00959   0.00000   0.00000   0.00000
  12        4ZZ        -0.00043  -0.00214   0.00000   0.00000   0.00000
  13        4XY         0.00000   0.00000   0.00000   0.00000   0.00000
  14        4XZ         0.00000   0.00000   0.00000   0.00000   0.00000
  15        4YZ         0.00000   0.00000   0.00000   0.00000   0.00000
  16 2   H  1S         -0.00108   0.01921   0.00000   0.05429   0.03374
  17        2S          0.00105  -0.01299   0.00000   0.01708   0.01168
  18 3   H  1S         -0.00108   0.01921   0.00000   0.05429   0.03374
  19        2S          0.00105  -0.01299   0.00000   0.01708   0.01168
                           6         7         8         9        10
   6        3S          0.72352
   7        3PX         0.00000   0.51216
   8        3PY         0.00000   0.00000   0.14556
   9        3PZ         0.00000   0.00000   0.00000   0.28428
  10        4XX        -0.00698   0.00000   0.00000   0.00000   0.00036
  11        4YY         0.01193   0.00000   0.00000   0.00000  -0.00010
  12        4ZZ        -0.02032   0.00000   0.00000   0.00000  -0.00007
  13        4XY         0.00000   0.00000   0.00000   0.00000   0.00000
  14        4XZ         0.00000   0.00000   0.00000   0.00000   0.00000
  15        4YZ         0.00000   0.00000   0.00000   0.00000   0.00000
  16 2   H  1S          0.00182   0.00000   0.05858   0.04455  -0.00048
  17        2S         -0.05984   0.00000   0.02907   0.02562  -0.00003
  18 3   H  1S          0.00182   0.00000   0.05858   0.04455  -0.00048
  19        2S         -0.05984   0.00000   0.02907   0.02562  -0.00003
                          11        12        13        14        15
  11        4YY         0.00083
  12        4ZZ         0.00021   0.00613
  13        4XY         0.00000   0.00000   0.00000
  14        4XZ         0.00000   0.00000   0.00000   0.00251
  15        4YZ         0.00000   0.00000   0.00000   0.00000   0.00341
  16 2   H  1S          0.00199   0.00606   0.00000   0.00000   0.00636
  17        2S          0.00002   0.00517   0.00000   0.00000   0.00071
  18 3   H  1S          0.00199   0.00606   0.00000   0.00000   0.00636
  19        2S          0.00002   0.00517   0.00000   0.00000   0.00071
                          16        17        18        19
  16 2   H  1S          0.19280
  17        2S          0.06719   0.06652
  18 3   H  1S         -0.00164  -0.00727   0.19280
  19        2S         -0.00727  -0.00723   0.06719   0.06652
	</comment>

	<record />

	<templateList>
		<template id="l601.popfull" repeat="*"
				  pattern="\s*\d*\s+\d*\s+\d*\s+\d*\s*\d*\s*$"
				  endPattern="\s*\d*\s+\d*\s+\d*\s+\d*\s*\d*\s*" endOffset="0"
				  endPattern2="~" 															 endOffset2="1">
			
			<record />
			<record id="mulliken" repeat="*">\s*{I,x:serial}\s+\d*\s*\w*\s*\w+\s+{1_5F,cc:mulliken}\s*</record>

		</template>
	</templateList>

	<transform process="joinArrays" xpath=".//cml:module[@cmlx:templateRef='l601.popfull']//cml:array[@dictRef='cc:mulliken']" />
	<transform process="createArray" xpath="." from=".//cml:module[@cmlx:templateRef='l601.popfull'][1]//cml:scalar[@dictRef='x:serial']" />

	<transform process="pullup" xpath=".//cml:array[@dictRef='cc:mulliken']" repeat="3" />

	<transform process="createMatrix" xpath="." from=".//cml:array[@dictRef='cc:mulliken']" dictRef="cc:mulliken" />

	<!-- add attributes to matrix -->
	<transform process="addAttribute" xpath=".//cml:matrix[@dictRef='cc:mulliken']" name="rows" 
			       value="$number(//cml:module[@cmlx:templateRef='l601.popfull'][1]//cml:array[@dictRef='x:serial']/@size)" />
	<transform process="addAttribute" xpath=".//cml:matrix[@dictRef='cc:mulliken']" name="columns" 
			       value="$number(//cml:module[@cmlx:templateRef='l601.popfull'][1]//cml:array[@dictRef='x:serial']/@size)" />
	<transform process="addAttribute" xpath=".//cml:matrix[@dictRef='cc:mulliken']" name="matrixType" value="squareSymmetricLT" />
	<transform process="addUnits" xpath=".//cml:matrix[@dictRef='cc:mulliken']" value="si:none" />

	<!-- remove redundant x:serial -->
	<transform process="delete" xpath=".//cml:module[@cmlx:templateRef='l601.popfull']//cml:array[@dictRef='x:serial']" />
	<transform process="delete" xpath=".//cml:module[@cmlx:templateRef='l601.popfull']//cml:scalar[@dictRef='x:serial']" />

	<!-- wrap in property -->
	<transform process="addChild" xpath="." elementName="cml:property" dictRef='cc:fullPopulationAnalysis' position="0" />
	<transform process="move" xpath=".//cml:matrix[@dictRef='cc:mulliken']" to=".//cml:property[@dictRef='cc:fullPopulationAnalysis']" />

	<!-- CLEAN UP -->
	<transform process="delete" xpath=".//cml:list[count(*)=0]" />
	<transform process="delete" xpath=".//cml:list[count(*)=0]" />
	<transform process="delete" xpath=".//cml:module[count(*)=0]" />

	<comment class="example.output" id="l601.popfull">
		<module xmlns="http://www.xml-cml.org/schema" xmlns:cmlx="http://www.xml-cml.org/schema/cmlx" cmlx:templateRef="l601.popfull">
			<property dictRef="cc:fullPopulationAnalysis">
				<matrix dataType="xsd:double" dictRef="cc:mulliken" rows="19" columns="19" matrixType="squareSymmetricLT" units="si:none">2.07485 -0.04107 0.50455 0.0 0.0 0.83097 0.0 0.0 0.0 0.53551 0.0 0.0 0.0 0.0 0.64157 -0.03955 0.4265 0.0 0.0 0.0 0.0 0.0 0.32718 0.0 0.0 0.0 0.0 0.0 0.14002 0.0 0.0 0.0 0.0 0.0 0.21372 -3.6E-4 -0.00589 0.0 0.0 0.0 -7.9E-4 0.00959 0.0 0.0 0.0 -4.3E-4 -0.00214 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 -0.00108 0.01921 0.0 0.05429 0.03374 0.00105 -0.01299 0.0 0.01708 0.01168 -0.00108 0.01921 0.0 0.05429 0.03374 0.00105 -0.01299 0.0 0.01708 0.01168 0.72352 0.0 0.51216 0.0 0.0 0.14556 0.0 0.0 0.0 0.28428 -0.00698 0.0 0.0 0.0 3.6E-4 0.01193 0.0 0.0 0.0 -1.0E-4 -0.02032 0.0 0.0 0.0 -7.0E-5 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.00182 0.0 0.05858 0.04455 -4.8E-4 -0.05984 0.0 0.02907 0.02562 -3.0E-5 0.00182 0.0 0.05858 0.04455 -4.8E-4 -0.05984 0.0 0.02907 0.02562 -3.0E-5 8.3E-4 2.1E-4 0.00613 0.0 0.0 0.0 0.0 0.0 0.0 0.00251 0.0 0.0 0.0 0.0 0.00341 0.00199 0.00606 0.0 0.0 0.00636 2.0E-5 0.00517 0.0 0.0 7.1E-4 0.00199 0.00606 0.0 0.0 0.00636 2.0E-5 0.00517 0.0 0.0 7.1E-4 0.1928 0.06719 0.06652 -0.00164 -0.00727 0.1928 -0.00727 -0.00723 0.06719 0.06652</matrix>
			</property>
		</module>
	</comment>
</template>