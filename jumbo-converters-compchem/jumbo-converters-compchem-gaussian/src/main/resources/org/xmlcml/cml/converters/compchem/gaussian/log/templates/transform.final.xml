<transformList
  xmlns:xi="http://www.w3.org/2001/XInclude"
  >

<!--  ====================== FINALIZATION ===================== -->
    
  <!-- build finalization module -->
  
  <transform process="addChild" xpath="//cml:module[@id='job']" elementName="cml:module" id="finalization"/>
  <transform process="addDictRef" xpath="//cml:module[@id='finalization']" value="cc:finalization"/>
  
  <transform process="addChild" xpath="//cml:module[@id='finalization']" elementName="cml:propertyList" />

  <!-- move modules to finalization -->
  
  <transform process="moveRelative" xpath=".//cml:module[@cmlx:templateRef='jobcpu']/cml:scalar[starts-with(@dictRef,'cc:job')]" 
    toXpath="./ancestor::*[@dictRef='cc:job']/cml:module[@id='finalization']/cml:propertyList"/>
     
  <transform process="moveRelative" 
    xpath=".//cml:module[starts-with(@cmlx:templateRef,'l601')][last()] |
           .//cml:module[starts-with(@cmlx:templateRef,'l716')][last()] |
           .//cml:module[starts-with(@cmlx:templateRef,'l801')][last()]
     " 
    toXpath="./ancestor::*[@dictRef='cc:job']/cml:module[@id='finalization']/cml:propertyList"/> 
    
  <transform process="moveRelative" xpath="
    .//cml:module[@cmlx:templateRef='l9999.final'][1] |
    .//cml:module[@cmlx:templateRef='l9999.archive'][1]" 
    toXpath="./ancestor::*[@dictRef='cc:job']/cml:module[@id='finalization']"/> 
  
  <transform process="addDictRef" xpath=".//cml:module[@id='finalization']/cml:module" 
    value="cc:userDefinedModule" />

  <!-- move properties to finalization -->
  
  <transform process="moveRelative" xpath=".//cml:module[@cmlx:templateRef='l9999.archive']/cml:scalar[
    @dictRef='cc:electronicstate'] | 
    .//cml:module[@cmlx:templateRef='l9999.archive']/cml:scalar[starts-with(@dictRef,'cc:') and contains(@dictRef,'energy')][last()] |
    .//cml:module[@cmlx:templateRef='l9999.archive']/cml:scalar[@dictRef='cc:rmsd'][last()] |
    .//cml:module[@cmlx:templateRef='l9999.archive']/cml:scalar[@dictRef='cc:rmsf'][last()] |
    .//cml:module[@cmlx:templateRef='l9999.archive']/cml:array[@dictRef='cc:dipole'][last()]" 
    toXpath="./ancestor::*[@dictRef='cc:job']/cml:module[@id='finalization']/cml:propertyList"/> 

  
  <transform process="addChild" xpath="//cml:module[@id='finalization']" elementName="cml:module" id="otherComponents"/>
  <transform process="addDictRef" xpath=".//cml:module[@id='finalization']/cml:module[@id='otherComponents']" value="cc:userDefinedModule" />

  <transform process="moveRelative" xpath="//cml:module[@id='finalization']/cml:module[not(@id='otherComponents')]" 
    toXpath="./ancestor::*[@dictRef='cc:job']/cml:module[@id='finalization']/cml:module[@id='otherComponents']"/>
  <transform process="moveRelative" xpath="//cml:module[@id='finalization']//cml:molecule[1]" 
    toXpath="./ancestor::*[@dictRef='cc:job']/cml:module[@id='finalization']"/>

  <transform process="pullup" xpath="//cml:module[@cmlx:templateRef='l716']/cml:module[starts-with(@cmlx:templateRef,'l716.')]"/>
  <transform process="pullup" xpath="//cml:module[@cmlx:templateRef='l601.polariz']/cml:array"/>
  <transform process="delete" xpath="//cml:module[count(*)=0]"/>
  
  <!--  forcematrix -->
  <!-- 
- <property>
- <module cmlx:templateRef="l716.forcematrix">
  <array dataType="xsd:integer" dictRef="x:serial" size="9">1 2 3 4 5 6 7 8 9</array> 
  <array delimiter="|" dataType="xsd:string" dictRef="cc:irrep" size="9">|T2|T2|T2|E|E|A1|T2|T2|T2|</array> 
  <array dataType="xsd:double" dictRef="cc:frequency" size="9">1373.4987 1373.4987 1373.4987 1593.9619 1593.9619 3053.5976 3163.9228 3163.9228 3163.9228</array> 
  <array dataType="xsd:double" dictRef="cc:redmass" size="9">1.1787 1.1787 1.1787 1.0078 1.0078 1.0078 1.1019 1.1019 1.1019</array> 
  <array dataType="xsd:double" dictRef="cc:forceconst" size="9">1.3101 1.3101 1.3101 1.5087 1.5087 5.5368 6.4991 6.4991 6.4991</array> 
  <array dataType="xsd:double" dictRef="cc:irintensity" size="9">15.4253 15.4253 15.4253 0.0 0.0 0.0 26.421 26.421 26.421</array> 
  </module>
  </property>
   -->

 <!-- wrap all properties -->
  <transform process="createWrapperProperty" xpath="//cml:module[@id='finalization']/cml:propertyList/*" />  
  <transform process="createWrapper" xpath="//cml:module[@id='finalization']/cml:propertyList/cml:module" elementName="cml:property"/>  

  <xi:include href="transform.l716.tidy.xml"/>
  <xi:include href="transform.l601.tidy.xml"/>

  <transform process="delete" xpath="//cml:module[@id='finalization']//cml:property/cml:module[count(*)=0]"/>  
  
  
</transformList> 