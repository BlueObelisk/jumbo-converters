<transformList
  xmlns:xi="http://www.w3.org/2001/XInclude"
  >

<!--  ====================== FINALIZATION ===================== -->
    
  <!-- build finalization module -->
  
  <transform process="addChild" xpath="//cml:module[@id='job']" elementName="cml:module" id="finalization"/>
  <transform process="addDictRef" xpath="//cml:module[@id='finalization']" value="cc:finalization"/>
  
  <transform process="addChild" xpath="//cml:module[@id='finalization']" elementName="cml:propertyList" />

  <!-- move modules to finalization -->
  
  <transform process="moveRelative" xpath=".//cml:module[@cmlx:templateRef='jobcpu']/cml:scalar[starts-with(@dictRef,'cc:job')]" 
             to="./ancestor::*[@dictRef='cc:job']/cml:module[@id='finalization']/cml:propertyList"/>
     
  <transform process="moveRelative" 
    xpath=".//cml:module[starts-with(@cmlx:templateRef,'l601')][last()] |
           .//cml:module[starts-with(@cmlx:templateRef,'l716')][last()] |
           .//cml:module[starts-with(@cmlx:templateRef,'l801')][last()]
     " 
    to="./ancestor::*[@dictRef='cc:job']/cml:module[@id='finalization']/cml:propertyList"/> 
    
  <transform process="moveRelative" xpath="
    .//cml:module[@cmlx:templateRef='l9999.final'][1] |
    .//cml:module[@cmlx:templateRef='l9999.archive'][1]" 
    to="./ancestor::*[@dictRef='cc:job']/cml:module[@id='finalization']"/> 
  
  <transform process="addDictRef" xpath=".//cml:module[@id='finalization']/cml:module" 
    value="cc:userDefinedModule" />

  <!-- move properties to finalization -->
  
  <transform process="moveRelative" xpath=".//cml:module[@cmlx:templateRef='job']/cml:scalar[
    @dictRef='cc:electronicstate'] | 
    .//cml:module[@cmlx:templateRef='job']//cml:scalar[starts-with(@dictRef,'cc:') and contains(@dictRef,'Energy')][last()] |
    .//cml:module[@cmlx:templateRef='job']//cml:scalar[@dictRef='cc:rmsd'][last()] |
    .//cml:module[@cmlx:templateRef='job']//cml:scalar[@dictRef='cc:rmsf'][last()] |
    .//cml:module[@cmlx:templateRef='job']//cml:array[@dictRef='cc:dipole'][last()]" 
    to="./ancestor::*[@dictRef='cc:job']/cml:module[@id='finalization']/cml:propertyList"/> 

  <transform process="copy" to="./ancestor::cml:module[@dictRef='cc:job']/cml:module[@id='finalization']/cml:propertyList"
             xpath=".//cml:module[@cmlx:templateRef='job']/cml:module[@dictRef='cc:calculation']//cml:module[@cmlx:templateRef='l301.basis'][last()]/cml:property[@dictRef='cc:Energy_NucRep']" />

  <transform process="addChild" xpath="//cml:module[@id='finalization']" elementName="cml:module" id="otherComponents"/>
  <transform process="addDictRef" xpath=".//cml:module[@id='finalization']/cml:module[@id='otherComponents']" value="cc:userDefinedModule" />

  <transform process="moveRelative" xpath="//cml:module[@id='finalization']/cml:module[not(@id='otherComponents')]" 
    to="./ancestor::*[@dictRef='cc:job']/cml:module[@id='finalization']/cml:module[@id='otherComponents']"/>
  <transform process="moveRelative" xpath="//cml:module[@id='finalization']//cml:molecule[1]" 
    to="./ancestor::*[@dictRef='cc:job']/cml:module[@id='finalization']"/>

  <transform process="pullup" xpath="//cml:module[@cmlx:templateRef='l716']/cml:module[starts-with(@cmlx:templateRef,'l716.')]"/>
  <transform process="pullup" xpath="//cml:module[@cmlx:templateRef='l601.polariz']/cml:array"/>
  <transform process="delete" xpath="//cml:module[count(*)=0]"/>

  <transform process="moveRelative" to="./ancestor::cml:module[@dictRef='cc:finalization']/cml:propertyList"
             xpath=".//cml:module[@dictRef='cc:job']/cml:module[@dictRef='cc:finalization']/cml:module[@dictRef='cc:userDefinedModule']/cml:module[@cmlx:templateRef='l9999.archive']/cml:array[@dictRef='cc:forceConstantMatrix' or @dictRef='cc:gradients']" />
  
 <!-- wrap all properties -->
  <transform process="createWrapperProperty" xpath="//cml:module[@id='finalization']/cml:propertyList/*" />  
  <transform process="createWrapper" xpath="//cml:module[@id='finalization']/cml:propertyList/cml:module" elementName="cml:property"/>

  <xi:include href="transform.l716.tidy.xml"/>
  <xi:include href="transform.l601.tidy.xml"/>

  <transform process="delete" xpath="//cml:module[@id='finalization']//cml:property/cml:module[count(*)=0]"/>

  <transform process="moveRelative" to="../cml:property[@dictRef='cc:thermochemistry']/cml:list[@id='l716.thermochemistry']"
             xpath=".//cml:module[@dictRef='cc:finalization']/cml:propertyList/cml:property[@dictRef='cc:Energy_ZPVE']" />

  <transform process="addDictRef" value="cc:Energy_ZPVE"
             xpath=".//cml:module[@dictRef='cc:finalization']/cml:propertyList/cml:property[@dictRef='cc:thermochemistry']/cml:list/cml:property[@dictRef='cc:Energy_ZPVE']/cml:scalar" />

  <transform process="pullupSingleton" 
             xpath=".//cml:module[@dictRef='cc:finalization']/cml:propertyList/cml:property[@dictRef='cc:thermochemistry']/cml:list/cml:property[@dictRef='cc:Energy_ZPVE']" />

  <!-- create and update thermochemistry module -->
  
  <transform process="addChild"
             xpath=".//cml:module[@dictRef='cc:job']/cml:module[@dictRef='cc:finalization']"
             elementName="cml:module"
             dictRef="cc:thermochemistry" />

  <transform process="moveRelative" to="../../cml:module[@dictRef='cc:thermochemistry']"
             xpath=".//cml:module[@dictRef='cc:job']/cml:module[@dictRef='cc:finalization']/cml:propertyList/cml:property[contains(@dictRef,'thermochemistry')]" />

  <transform process="addChild"
             xpath=".//cml:module[@dictRef='cc:job']/cml:module[@dictRef='cc:finalization']/cml:module[@dictRef='cc:thermochemistry']"
             elementName="cml:parameterList" />
  
  <transform process="moveRelative" to="../../../cml:parameterList"
             xpath=".//cml:module[@dictRef='cc:job']/cml:module[@dictRef='cc:finalization']/cml:module[@dictRef='cc:thermochemistry']/cml:property[@dictRef='cc:thermochemistry']//cml:scalar[@dictRef='cc:temp' or @dictRef='cc:press']" />

  <transform process="addChild"
             xpath=".//cml:module[@dictRef='cc:job']/cml:module[@dictRef='cc:finalization']/cml:module[@dictRef='cc:thermochemistry']"
             elementName="cml:propertyList" />

  <transform process="moveRelative" to="../../cml:propertyList"
             xpath=".//cml:module[@dictRef='cc:job']/cml:module[@dictRef='cc:finalization']/cml:module[@dictRef='cc:thermochemistry']/cml:property[contains(@dictRef,'cc:thermochemistry')]/cml:list" />

  <transform process="moveRelative" to="../../cml:module[@dictRef='cc:thermochemistry']/cml:propertyList"
             xpath=".//cml:module[@dictRef='cc:job']/cml:module[@dictRef='cc:finalization']/cml:propertyList/cml:property[@dictRef='cc:GibbsEnergy_T']" />

  <transform process="pullup" 
             xpath=".//cml:module[@dictRef='cc:job']/cml:module[@dictRef='cc:finalization']/cml:module[@dictRef='cc:thermochemistry']/cml:propertyList/cml:list/cml:scalar" />
  <transform process="pullup" 
             xpath=".//cml:module[@dictRef='cc:job']/cml:module[@dictRef='cc:finalization']/cml:module[@dictRef='cc:thermochemistry']/cml:propertyList/cml:list/cml:array" />
  <transform process="pullup" 
             xpath=".//cml:module[@dictRef='cc:job']/cml:module[@dictRef='cc:finalization']/cml:module[@dictRef='cc:thermochemistry']/cml:propertyList/cml:list/cml:list" />

  <transform process="addDictRef" value="cc:isotopes"
             xpath=".//cml:module[@dictRef='cc:thermochemistry']/cml:propertyList/cml:list[@cmlx:templateRef='mass']" />

  <transform process="moveRelative" to="../../cml:parameterList"
             xpath=".//cml:module[@dictRef='cc:thermochemistry']/cml:propertyList/cml:list[@dictRef='cc:isotopes']" />

  <transform process="createWrapperParameter" 
             xpath=".//cml:module[@dictRef='cc:job']/cml:module[@dictRef='cc:finalization']/cml:module[@dictRef='cc:thermochemistry']/cml:parameterList/cml:scalar[contains(@dictRef,'cc:')]" />
  <transform process="createWrapperParameter"  
             xpath=".//cml:module[@dictRef='cc:job']/cml:module[@dictRef='cc:finalization']/cml:module[@dictRef='cc:thermochemistry']/cml:parameterList/cml:list[@dictRef='cc:isotopes']" />
  <transform process="createWrapperProperty"  
             xpath=".//cml:module[@dictRef='cc:job']/cml:module[@dictRef='cc:finalization']/cml:module[@dictRef='cc:thermochemistry']/cml:propertyList/cml:scalar[contains(@dictRef,'cc:')]" />
  <transform process="createWrapperProperty"  
             xpath=".//cml:module[@dictRef='cc:job']/cml:module[@dictRef='cc:finalization']/cml:module[@dictRef='cc:thermochemistry']/cml:propertyList/cml:array[contains(@dictRef,'cc:') or contains(@dictRef,'x:')]" />

  <!-- create and update frequencyAnalysis module -->
  <transform process="addChild"
             xpath=".//cml:module[@dictRef='cc:job']/cml:module[@dictRef='cc:finalization']"
             elementName="cml:module"
             dictRef="cc:frequencyAnalysis" />

  <transform process="moveRelative" to="../cml:module[@dictRef='cc:frequencyAnalysis']"
             xpath=".//cml:module[@dictRef='cc:job']/cml:module[@dictRef='cc:finalization']/cml:module[@dictRef='cc:thermochemistry']" />

  <transform process="addChild"
             xpath=".//cml:module[@dictRef='cc:job']/cml:module[@dictRef='cc:finalization']/cml:module[@dictRef='cc:frequencyAnalysis']"
             elementName="cml:parameterList"
             position="0" />

  <transform process="moveRelative" to="../../../cml:parameterList"
             xpath=".//cml:module[@dictRef='cc:job']/cml:module[@dictRef='cc:finalization']/cml:module[@dictRef='cc:frequencyAnalysis']/cml:module[@dictRef='cc:thermochemistry']/cml:parameterList/
             cml:parameter[@dictRef='cc:isotopes']" />

  <transform process="addChild"
             xpath=".//cml:module[@dictRef='cc:job']/cml:module[@dictRef='cc:finalization']/cml:module[@dictRef='cc:frequencyAnalysis']"
             elementName="cml:propertyList"
             position="1" />

  <transform process="moveRelative" to="../../../cml:propertyList"
             xpath=".//cml:module[@dictRef='cc:job']/cml:module[@dictRef='cc:finalization']/cml:module[@dictRef='cc:frequencyAnalysis']/cml:module[@dictRef='cc:thermochemistry']/cml:propertyList/
             cml:property[@dictRef='cc:molmass' or @dictRef='cc:symmnumber'or @dictRef='cc:Energy_ZPVE' or @dictRef='cc:rottemp' or @dictRef='cc:rotconst' or @dictRef='cc:vibtemp']" />

  <transform process="moveRelative" to="./ancestor::cml:module[@dictRef='cc:finalization']/cml:module[@dictRef='cc:frequencyAnalysis']/cml:propertyList"
             xpath=".//cml:module[@dictRef='cc:job']/cml:module[@dictRef='cc:finalization']/cml:propertyList/cml:property[@dictRef='cc:frequencies' or @dictRef='cc:vibrations' or @dictRef='cc:forces' or @dictRef='g:l716.lowfreq']" />

  <transform process="moveRelative" to="./ancestor::cml:module[@id='job']/cml:module[@id='calculation']"
             xpath=".//cml:module[@id='job'][1]/cml:module[@id='finalization']/cml:propertyList/cml:property[@dictRef='cc:popanal'][1]/cml:module[@cmlx:templateRef='l601.popanal']" />

  <transform process="pullup" xpath=".//cml:module[@dictRef='cc:finalization']/cml:propertyList/cml:property[@dictRef='cc:popanal']//cml:property" repeat="2" />

  <!-- CLEAN UP -->
  <transform process="delete" xpath=".//cml:list[count(*)=0]" />
  <transform process="delete" xpath=".//cml:list[count(*)=0]" />
  <transform process="delete" xpath=".//cml:parameterList[count(*)=0]" />
  <transform process="delete" xpath=".//cml:propertyList[count(*)=0]" />
  <transform process="delete" xpath=".//cml:property[count(*)=0]" />
  <transform process="delete" xpath=".//cml:module[count(*)=0]" />
  <transform process="delete" xpath=".//cml:module[count(*)=0]" />
</transformList> 